# SSH Rate Limiting Rules for pf (macOS Firewall)
# Protects SSH service from brute-force attacks

# Table for blocked IPs (SSH brute force attempts)
table <ssh_bruteforce> persist

# Block IPs that are in the brute force table
block in quick from <ssh_bruteforce>

# SSH rate limiting for port 2222
# Block hosts that make more than 5 connections in 30 seconds
pass in on en0 proto tcp to any port 2222 flags S/SA keep state \
  (max-src-conn 5, max-src-conn-rate 5/30, \
   overload <ssh_bruteforce> flush global)

# Mosh UDP ports (60000-61000) - allow without rate limiting
# Mosh handles its own connection management
pass in on en0 proto udp to any port 60000:61000 keep state

# Allow established connections
pass in on en0 proto tcp to any port 2222 flags A/A keep state

# Allow ICMP for network diagnostics
pass in on en0 proto icmp all keep state

# Allow loopback traffic
pass in on lo0 all
pass out on lo0 all